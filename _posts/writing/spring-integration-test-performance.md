---
layout: post
comments: true
title: 스프링 통합테스트 성능향상을 위한 여정
tags: [java, spring, integrationtest]
---

### 개요

테스트 성능개선에 대한 이야기는 다루고있는곳이 많지만 대부분 유닛테스트를 타겟으로 이야기를 하고있습니다. 유닛테스트의 경우 어느정도 숙달되면 빠르고 독립적인 테스트코드를 만드는것이 어렵지 않지만 대부분의 통합테스트는 DB, API Connection, SpringContext 등 연계된 시스템들이 많아 고려할것도 많고 유닛테스트에 비해 실행속도도 느릴 수 밖에 없습니다.

가능하면 유닛테스트를 통해 모든 코드를 검증 할 수 있다면 좋겠지만, 로직 흐름을 정확하게 테스트하기 위해서는 잘짜여진 통합테스트만한것이 없을것입니다. 오늘은 테스트중에서도 통합테스트 성능을 높이기위한 방법들에 대해서 이야기를 해보고자 합니다.

먼저, 오늘 다룰 통합테스트에 대한 용어정리를 하고 가도록 하겠습니다.  
통합테스트는 보통 로직이 수행되는 여러 모듈들을 통합하여 테스트하는것을 의미할텐데 여기에서는 간단하게 `SpringBoot`기반에서 `@SpringBootTest`를 통해 테스트하는 모든 테스트코드들을 통합테스트로 정의하도록 하고 본론으로 들어가도록 하겠습니다.

---
### 스프링 통합테스트 성능 향상을 위한 여정
#### 1. 통합테스트는 느리다!

통합테스트 성능 향상을 소개드린다고 했는데 갑자기 통합테스트는 느리다고하니 무슨말인가 싶을수 있으실텐데 통합테스트는 어떤수를 쓰더라도 단위테스트보다 느릴수밖에 없습니다. 따라서 단위테스트로 검증이 가능한 테스트일 경우 가능하면 통합테스트대신 단위테스트로 변경하는것이 가장 효과적이고 바람직한 성능향상의 방향입니다.

### 2. 테스트 실행을 분리하자.

두번째 방법은 `느린테스트는 자주 수행시키지 않는다`는것 입니다.
위에서 `통합테스트는 느리다` 라고 말씀을 드렸으니 결국, 통합테스트는 자주 수행하지 말아야한다의 뜻으로 전달드릴수 있겠습니다. 
테스트 수행은 코드를 작성하는 과정에서 수시로 실행되어야 할텐데, 매번 오래걸리는 통합테스트가 함께 실행된다면 그만큼 비효율적이지 않을수 없을것입니다. 특히나 대규모시스템에서의 잦은 통합테스트 실행은 상당한 시간이 소요되니 로컬 테스트뿐만 아니라 CI를 통한 테스트를 수행시에도 많은 시간이 소요 될 수 있습니다. 

따라서 제안드리는 방법은 `통합테스트`실행과 `단위테스트`실행을 분리해 통합테스트는 필요할때만 테스팅을 수행 시키는 것 입니다.  
`JUnit5 Tag` 기능을 사용해 간단하게 Intellij, Gradle 에서 실행을 분리시킬수 있습니다.

### 3. 외부 호출 Mocking

통합테스트를 수행하는 목적중 하나는 전체 로직 실행 프로세스를 테스트하는 것 이긴 하지만 단순 정보조회 혹은 상태변경등 충분히 예측가능하고 검증된 API를 호출하는 경우에는 과감하게 `Mocking`을 통해 외부시스템 호출을 제거하고 성능을 향상시킬수 있습니다. 

### 4. Spring Context 리로드 최소화

위 테스트 실행 예시들을 보시면서 느끼셨겠지만 통합테스트 수행에서 많은 시간을 차지하는것은 `SpringContext`를 초기화하는 작업입니다. 따라서 통합테스트의 성능향상에서 가장 고려해야할 부분은 `SpringContext` 초기화를 줄이는데 신경을 써야합니다. 다행히도 `SpringBootTest`에는 `ContextCaching` 캐싱전략이 반영되어 있기때문에 캐시를 잘 활용한다면 통합테스트 성능향상에 큰 도움이 될 수 있습니다.  

그렇다면 어떤 케이스에서 캐시가 히트 될 수 있는지 확인하기 위해 캐시 키를 구성하는 구성요소들을 살펴보면 아래와같습니다.
https://docs.spring.io/spring-framework/docs/current/reference/html/testing.html#testcontext-ctx-management-caching


- `@MockBean`, `@SpyBean`의 사용
- `@TestPropertySource`, `@ContextConfiguration`, `@ActiveProfiles`등 테스트 클래스에서 특정 속성 변경 사용
- `@WebAppConfiguration` resource base 변경
- `@DirtiesContext` 사용으로 의도적인 dirtyContext 사용

위와같은 케이스가 있는경우 통합테스트의 성능이 매우 나빠질 수 있습니다.

- Spring Context Caching

Spring 테스트에서 `MockBean`,`SpyBean`을 사용하다보면 테스트 수행 과정중 자주 딜레이가 생기면서 Spring Context가 자꾸 재시작하는 현상을 확인 할 수 있습니다.
또한 TestProperty 설정 등의 옵션도 SpringContext 리로드를 유발하니 가능하면 해당기능들을 적게 사용하는것이 좋습니다.
`DirtiesContext`제거

- 테스트 클래스 통합

어쩔수없이 SpringContext를 변경해야 할 경우 클래스를 통합해 가능한 적은수의 Context reload가 일어나도록 한다
이때 또하나의 팁은 NestedClass를 통해 테스트들을 분리시켜주는것이 좋습니다.


### 5. 통합 테스트 병렬실행?
Junit5에서 병렬실행을 지원하고는 있지만 `@SpringBootTest`에서 병렬실행은 불안정하며 매번 다른쓰레드로 실행하기때문에 context chaching이 적용되지않아 오히려 역효과를 낼 수 있다. 
테스트가 병렬로 수행하면서 Singletone `MockBean`이 병렬수행되면서 기대하지 않는 동작이 수행 될 수 있음
상황에따라 가벼운 시스템에서는 적용해볼법함.

---

### 마무리







