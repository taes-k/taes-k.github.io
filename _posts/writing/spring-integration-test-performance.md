---
layout: post
comments: true
title: 스프링 통합테스트 성능향상을 위한 여정
tags: [java, spring, integrationtest]
---

### 개요

테스트 성능개선에 대한 이야기는 다루고있는곳이 많지만 대부분 유닛테스트를 타겟으로 이야기를 하고있습니다. 유닛테스트의 경우 어느정도 숙달되면 빠르고 독립적인 테스트코드를 만드는것이 어렵지 않지만 대부분의 통합테스트는 DB, API Connection, SpringContext 등 연계된 시스템들이 많아 고려할것도 많고 유닛테스트에 비해 실행속도도 느릴 수 밖에 없습니다.

가능하면 유닛테스트를 통해 모든 코드를 검증 할 수 있다면 좋겠지만, 로직 흐름을 정확하게 테스트하기 위해서는 잘짜여진 통합테스트만한것이 없을것입니다. 오늘은 테스트중에서도 통합테스트 성능을 높이기위한 방법들에 대해서 이야기를 해보고자 합니다.

먼저, 오늘 다룰 통합테스트에 대한 용어정리를 하고 가도록 하겠습니다.  
통합테스트는 보통 로직이 수행되는 여러 모듈들을 통합하여 테스트하는것을 의미할텐데 여기에서는 간단하게 `SpringBoot`기반에서 `@SpringBootTest`를 통해 테스트하는 모든 테스트코드들을 통합테스트로 정의하도록 하고 본론으로 들어가도록 하겠습니다.

---
### 스프링 통합테스트 성능 향상을 위한 여정
#### 1. 통합테스트는 느리다!

통합테스트 성능 향상을 소개드린다고 했는데 갑자기 통합테스트는 느리다고하니 무슨말인가 싶을수 있으실텐데 통합테스트는 어떤수를 쓰더라도 단위테스트보다 느릴수밖에 없습니다. 따라서 단위테스트로 검증이 가능한 테스트일 경우 가능하면 통합테스트대신 단위테스트로 변경하는것이 가장 바람직한 성능향상의 방향입니다.

### 2. 테스트 실행을 분리하자.

로컬 테스트, CI 테스트를 수행시 통합테스트를 매번 돌리는것은 비효율적.
단위테스트는 자주 돌려도 괜찮지만 대규모시스템에서의 잦은 통합테스트 실행은 상당한 시간이 소요
JUnit5 Tag 기능사용

### 3. 외부 호출 Mocking

통합테스트를 수행하는 목적중 하나는 전체 로직 실행 프로세스를 테스트하는것이긴 하나 단순 정보조회, 상태변경등 충분히 예측가능하고 검증된 API를 호출하는 로직이 포함되어있다면 과감히 Mocking 하고 외부 시스템 호출을 줄일 수 있습니다.

### 4. Spring Context 리로드 최소화

- Spring Context Caching

Spring 테스트에서 `MockBean`,`SpyBean`을 사용하다보면 테스트 수행 과정중 자주 딜레이가 생기면서 Spring Context가 자꾸 재시작하는 현상을 확인 할 수 있습니다.
또한 TestProperty 설정 등의 옵션도 SpringContext 리로드를 유발하니 가능하면 해당기능들을 적게 사용하는것이 좋습니다.
`DirtiesContext`제거

- 테스트 클래스 통합

어쩔수없이 SpringContext를 변경해야 할 경우 클래스를 통합해 가능한 적은수의 Context reload가 일어나도록 한다
이때 또하나의 팁은 NestedClass를 통해 테스트들을 분리시켜주는것이 좋습니다.


### 5. 통합 테스트 병렬실행?
Junit5에서 병렬실행을 지원하고는 있지만 `@SpringBootTest`에서 병렬실행은 불안정하며 매번 다른쓰레드로 실행하기때문에 context chaching이 적용되지않아 오히려 역효과를 낼 수 있다. 
테스트가 병렬로 수행하면서 Singletone `MockBean`이 병렬수행되면서 기대하지 않는 동작이 수행 될 수 있음
상황에따라 가벼운 시스템에서는 적용해볼법함.

---

### 마무리







